# {{ project_name }}

## Before You Act

**IMPORTANT:** Before executing any task, follow this EXACT sequence:

### Phase 1: Discovery (REQUIRED FIRST)
1. **Read `sop.md`** - Understand the full process and requirements
2. **Read `README.md`** - Check "Available Functions" section for existing implementations
3. **Read `env.md`** - Check all available API keys and environment variables
4. **Read relevant skills completely** - Look up ALL skills in `/skills`, read full SKILL.md
5. **Find existing functions** - Read `functions/__init__.py` for exports, then read function docstrings for "SOP Reference:" to find implementations
6. **Verify data schemas** - Read `resources/RESOURCES.md` and `resources/INTERNAL_DB.md`

### Phase 2: Database Verification (REQUIRED BEFORE CODE)
7. **Check persistence requirements** - Does this task need to store, cache, or remember data across executions?
8. **Review existing internal-db schema** - Read `resources/INTERNAL_DB.md` to see what tables already exist (migrations are typically applied during unfurl)
9. **Verify tables exist** - If the task uses internal-db, confirm required tables are present. If missing, create AND APPLY migrations immediately.
10. **Use existing functions** - Functions that interact with internal-db should already be implemented in `/functions`

### Phase 3: Implementation (ONLY AFTER PHASES 1-2)
11. **Implement using REAL DATA ONLY** - Use skills to fetch live data via available APIs. NEVER make up data, use placeholders, or simulate responses.
12. **Verify data sources first** - Read database schemas in `resources/RESOURCES.md`, examine template file formats in `resources/` or `input/` before writing code that uses them
13. **Use available tools** - Always call actual APIs and skills rather than fabricating what you think they might return

**CRITICAL: Do NOT skip phases. Do NOT write code before reviewing skills and running migrations. NOTHING should be made up - always use real data from available sources.**

## Layout

```
{{ project_slug }}/
├── sop.md          # Source SOP (markdown)
├── README.md       # Function documentation (auto-generated)
├── env.md          # External services docs
├── UNFURL.md       # Code generation instructions
├── ENTRY.md        # This file
│
├── input/          # Input files for processing
├── output/         # Generated output files
│
├── resources/          # Project resources (data files, database schemas)
│   └── RESOURCES.md    # Resource manifest (auto-generated)
│   └── INTERNAL_DB.md  # Internal DB schema and tables (auto-generated)
│
├── skills/         # Specialized capabilities (see Skills section)
├── models/         # Pydantic data models
├── functions/      # Function implementations
└── tests/          # Pytest tests
└── migrations/     # Internal-DB migration files
```

## Resources

**IMPORTANT:** Before starting any task, check available project resources:

- **`resources/RESOURCES.md`** - File resources and external database schemas
- **`resources/INTERNAL_DB.md`** - Internal persistent database schema (if provisioned)
- **`env.md`** - Environment variables and secrets

### Resource Types

- **File Resources**: Data files, documents, and reference materials in `resources/` subdirectories
- **Database Resources**: SQL database schemas with table and column information
- **Internal Database**: Per-project DuckDB/MotherDuck database for persistent storage (see `INTERNAL_DB.md`)
- **Environment Variables**: Project-specific secrets and configuration (listed in `env.md`)

Read the resources manifest to understand what data is available for your implementation.

## File I/O

- **input/**: Place files here that functions need to process (e.g., documents, data files)
- **output/**: Functions write their generated results here (e.g., reports, processed data)

## Skills

The `skills/` directory contains specialized capabilities with documentation and utilities.

### Available Skills

| Skill | Purpose |
|-------|---------|
| `pdf` | Extract, create, merge, fill forms |
| `xlsx` | Create, edit, recalculate formulas |
| `docx` | Create, edit, tracked changes |
| `internal-comms` | Internal communications templates |
| `claude` | Text generation, JSON extraction, image analysis |
| `phonic` | AI phone agent for calls and transcripts |
| `browser-use` | AI browser for scraping and automation |
| `mapbox` | Geocoding, routing, distance matrices |
| `fulcrum-sdk` | Dispatch to user-facing timeline |
| `sql` | Query databases, read into DataFrames |
| `internal-db` | Persist data across tickets using MotherDuck/DuckDB |

Each skill has a `SKILL.md` with frontmatter (`name`, `description`, `license`), usage guides, and supporting files.

### Usage Patterns

**Library Pattern** - Run skill utilities directly:
```bash
uv run skills/xlsx/recalc.py output.xlsx
```

**Snippet Pattern** - Copy and adapt code from skill documentation:
- Read the SKILL.md for the relevant skill
- Find code examples matching your use case
- Adapt the pattern to your specific requirements

**Agentic Pattern** - Runtime skill invocation for complex tasks:
1. Read the skill's SKILL.md to understand capabilities
2. Follow the skill's workflow instructions
3. Use extended thinking (ultrathink) to plan thoroughly before implementation

### Database Choice Guide

| Use Case | Skill | Notes |
|----------|-------|-------|
| **Persist data across tickets** | `internal-db` | Project-scoped DuckDB, schema in `resources/INTERNAL_DB.md` |
| **Query external databases** | `sql` | Read from user-provided connection strings in env vars; schema in `resources/RESOURCES.md` |

**Internal DB** is automatically provisioned per project. Check `resources/INTERNAL_DB.md` for current schema.

### Internal Database Workflow

Migrations are typically applied during unfurl. For ticket execution:

1. **Check if internal-db is needed** - Does the task mention storing, caching, remembering, or persisting data?
2. **Review existing schema** - Read `resources/INTERNAL_DB.md` to see current tables (already created during unfurl)
3. **Find existing functions** - Check `/functions` for implementations that already handle internal-db operations
4. **Verify tables exist** - If functions fail with missing table errors, migrations may not have been applied

**If tables are missing** (rare - should have been created during unfurl):
```bash
uv run python migrations/001_create_table.py
```

See `skills/internal-db/SKILL.md` for connection patterns and `skills/internal-db/references/patterns.md` for common usage patterns.

## Python Environment

Use `uv` for all Python operations:

- Run scripts: `uv run script.py`
- Run with dependencies: `uv run --with package script.py`
- Run tests: `uv run pytest`
- Install dependencies: `uv sync`

## Function Pattern

```python
def function_name(data: InputModel) -> OutputModel:
    """
    Description.

    SOP Reference:
    > Cited text from sop.md
    """
    ...
```

## Naming

- Models: `PascalCase` (e.g., `Invoice`, `ValidationResult`)
- Functions: `snake_case` (e.g., `validate_invoice`)
- Fields: `snake_case` (e.g., `vendor_name`)
- Tests: `test_{function_name}.py`

## Agent Execution Guidelines

### Implementation Priority
When implementing functionality, prefer reusing existing code over writing new code:

1. **functions/** - Check for pre-written functions first. These are tested, project-specific implementations.
2. **skills/** - If no suitable function exists, use skill utilities and patterns from SKILL.md documentation.
3. **Custom implementation** - Only write new code when existing functions and skills don't meet the requirement.

This hierarchy ensures consistency, reduces errors, and leverages tested code.

### Finding Functions via Code Exploration

Discover existing function implementations through:

1. **README.md "Available Functions" table** - Primary source mapping functions to SOP sections
2. **functions/__init__.py** - Lists all exported functions
3. **Function docstrings** - Each function has "SOP Reference:" with cited SOP text

Example docstring pattern:
```python
def validate_invoice(data: InvoiceInput) -> ValidationResult:
    """
    Validate invoice against business rules.

    SOP Reference:
    > Check that the invoice total matches line items...
    """
```

When a task references an SOP section, search function docstrings for matching "SOP Reference" text.

### Real Data Requirements

**MANDATORY: Use Real Data Only. Nothing should be made up.**

Check `env.md` for available API keys, then use skills to fetch real data:
- `browser-use` for web data
- `sql` for external databases
- `internal-db` for persistent storage
- Files from `input/` or `resources/`

**PROHIBITED - Never use these in production code:**
- Hardcoded sample values ("John Doe", "123 Main St", "test@example.com")
- Simulated API responses
- Fabricated database records
- Placeholder data of any kind
- Made-up examples or dummy values

**Before writing code that interacts with external data:**
1. **Database schemas** - If querying databases, read `resources/RESOURCES.md` to verify table structures, column names, and data types
2. **Template files** - If reading/writing template files (Excel templates, Word documents, etc.) in `resources/` or `input/`, examine their actual format and structure first to ensure compatibility
3. **API responses** - Use the actual API via skills, never simulate what you think it might return

| Data Need | Skill | Env Variable |
|-----------|-------|--------------|
| Live web content | `browser-use` | `BROWSER_USE_API_KEY` |
| Geographic data | `mapbox` | `MAPBOX_API_KEY` |
| External databases | `sql` | Connection string in `resources/RESOURCES.md` |
| Persistent storage | `internal-db` | `FULCRUM_INTERNAL_DB_RW` |
| Phone responses | `phonic` | `PHONIC_API_KEY` |
| AI text/extraction | `claude` | `ANTHROPIC_API_KEY` |
| Documents | `pdf`, `xlsx`, `docx` | N/A (file-based) |

**Exception:** Tests are the ONLY place mock data is acceptable. Tests MUST mock all external side effects.

### Script Decomposition
Default to multiple scripts for multi-step work. Each script should have a clear start/end, write a checkpoint to a temporary folder like `tmp/`, and accept inputs from the previous step. Only use a single script when the task is truly atomic.

### Parallel Execution
Run independent tasks in parallel when there are no data dependencies or shared side effects. Explicitly identify dependencies; only serialize when one step consumes outputs from another.

### Output Handling
When users request deliverables (files, reports, data exports), **always place them in the `output/` folder**. This is the designated location for all user-requested outputs and results.

### Dispatch Milestones
Use the `fulcrum-sdk` skill to emit user-facing timeline updates for significant steps (phase starts, API calls, file creation). See the skill for full dispatch guidance.

### Error Recovery
- **Never re-run completed side effects** (API mutations, DB writes, phone calls)
- **Checkpoint to `tmp/`** - Write step outputs and IDs for resume capability
- **Resume from last success** - Create new script starting after failed step

### SOP Completion
Execute all applicable SOP steps to completion:

- Do not skip steps unless explicitly instructed
- Handle each step thoroughly before proceeding
- Report progress and any issues encountered
